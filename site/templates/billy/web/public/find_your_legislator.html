{% extends base_template %}
{% load customtags %}
{% load url from future %}

{% block title %}Find your Legislator!{% endblock %}

{% block bodyclass %}home{% endblock %}

{% block headblock %}
    <style>

.find_your_legislator_errorbox {
    color:                 #2e2020;
    padding:               10px;
    background-color:      #d99898;
    border:                1px solid #825b5b;
    -moz-border-radius:    5px;
    -webkit-border-radius: 5px;
}

.find_your_legislator_infobox {
    padding:               10px;
    background-color:      #b1e7fc;
    border:                1px solid #769aa8;
    -moz-border-radius:    5px;
    -webkit-border-radius: 5px;
}

.find_your_legislator_infobox  a {
    color:                 #3b4d54;
    text-decoration:       underline;
}

.leg_find_results {
    margin-top:            10px;
    margin-bottom:         10px;
}

#map{
    height:300px;
    background:#6699cc;
}


    </style>
    <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=true"></script>
    <script type="text/javascript" src="https://raw.github.com/HPNeo/gmaps/master/gmaps.js"></script>
    <script type="text/javascript">
$(document).ready(function() {
    var map;
    map = new GMaps({
        div: '#map',
        lat: 38,
        lng: -97,
        zoom: 3
    });
    function do_geo_locate(lat, lon) {
        var url = '/find_your_legislator/?lat=' +
               lat +
               '&lon=' +
               lon;

        /* This is a big operation. Kicking it off, since it's async */
        $.getJSON(url + "&boundry=y", function(data) {
            for ( var i in data ) {
                var bdry = data[i],
                    polygon;
                for ( var n in bdry.shape ) {
                    for ( var j in bdry.shape[n] ) {
                        var bak_shape = bdry.shape[n][j],
                                shape = []
                        for ( var node in bak_shape ) {
                            node = bak_shape[node];
                            shape.push([node[1], node[0]]);
                        }
                        polygon = map.drawPolygon({
                            paths:         shape,
                            strokeColor:   '#BBD8E9',
                            strokeOpacity: 1,
                            strokeWeight:  3,
                            fillColor:     '#BBD8E9',
                            fillOpacity:   0.6
                            });
                    }
                }
            }
        });

        /* Before we dispatch our request, we've already
           geo-located. Let's center first. */
        map.setZoom(12);
        map.setCenter(
            lat,
            lon
        );
        /* XXX: This is to remove all the other markers. Perhaps one day we
                can find a way to mark all searched locations w/ results. */
        map.removeMarkers();
        map.addMarker({
            lat: lat,
            lng: lon,
            click: function() {
                /* If the user clicks, let's recenter kindly. */
                map.setCenter(
                    lat,
                    lon
                );
            }
        });

        $("#results_table").html("<center>Loading....</center>")
        $("#results_table").load(url);
    }
    $('#find_your_leg').submit(function(e){
        e.preventDefault();
        GMaps.geocode({
            address: $('#leg_search').val().trim(),
            callback: function(results, status){
                if ( status == 'OK' ){
                    var  latlng = results[0].geometry.location,
                            lat = latlng.lat(),
                            lon = latlng.lng();
                    do_geo_locate(lat, lon);
                }
            }
        });
    });
    GMaps.geolocate({
        success: function(position) {
            {# XXX: This really needs to be patched up #}
            $("#communicate").append("<p class = 'find_your_legislator_infobox' >" +
                "We've been able to guess where you currently are. Click " +
                "<a id = 'do_geo_locate' href = '#' >" +
                "here</a> to look up your legislator." +
                "</p>");
            $("#do_geo_locate").click(function() {
                do_geo_locate(position.coords.latitude,
                    position.coords.longitude);
                return false;
            });
        },
        error: function(error) {
            /* $("#communicate").append("<p class = 'find_your_legislator_errorbox' >" +
            "We were not able to guess your location. Please enter in your details."+
            "</p>"); */
        }
    });
    if ( $("#_request").val().trim() != "" ) {
        $('#find_your_leg').submit();
    }
});
    </script>
{% endblock %}

{% block collection_nav %}{% endblock %}

{% block content %}
    <input type = 'hidden' value = '{{request}}' id = '_request' />
    <div id="container">
        <div class="nineCol colLt">
            <p class="callOut">Find your legislator!</p>
            <div id = 'communicate' ></div>
            <div id = 'find_your_legislator_search' >
                <form id = 'find_your_leg'>
                    <input type = 'text' name = 'leg_search' id = 'leg_search'
                        size = '50'
                        placeholder = '{{ address }}'
                        value = '{{ request }}' ></input>
                    <input type = 'submit' value = 'Submit' ></input>
                </form>
            </div>
            <div id = 'map' ></div>
            <div id = 'results_table' ></div>
        </div>
        <div class="clear"></div>
    </div>
{% endblock %}
